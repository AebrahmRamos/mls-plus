<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLSU Course Offerings</title>
    <style>
        :root {
            --primary-color: #338000;
            --primary-hover: #2a6800;
            --gray-light: #f4f4f4;
            --gray-lighter: #f8f9fa;
            --border-color: #ddd;
            --error-color: #d9534f;
            --open-section: #D2EED3;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --column-gap: 1.5rem;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--gray-light);
            line-height: 1.6;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .container {
            width: 100%;
            /* max-width: 1280px; */
            margin: 1.5rem auto;
            padding: 0 1rem;
        }
        
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }
        
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .search-form input {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .search-form button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        
        .search-form button:hover {
            background-color: var(--primary-hover);
        }
        
        .instructions {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--gray-lighter);
            border-radius: 4px;
        }
        
        .loading, .error, .no-results {
            text-align: center;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .loading {
            display: none;
            background-color: var(--gray-lighter);
        }
        
        .error {
            color: var(--error-color);
            border: 1px solid var(--error-color);
            display: none;
        }
        
        .no-results {
            color: #666;
            display: none;
        }
        
        /* True masonry layout with columns */
        .results-container {
            columns: 2 400px;
            column-gap: var(--column-gap);
            width: 100%;
        }
        
        /* For single column on mobile */
        @media (max-width: 767px) {
            .results-container {
                columns: 1;
            }
        }
        
        .course-container {
            break-inside: avoid;
            page-break-inside: avoid;
            margin-bottom: var(--column-gap);
            display: inline-block;
            width: 100%;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            padding: 1rem;
        }
        
        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .last-updated {
            margin-left: auto;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        .course-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-right: auto;
        }
        
        .section-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        .section-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .section-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            word-break: break-word;
        }
        
        .section-table tr:nth-child(even) {
            background-color: var(--gray-light);
        }
        
        .section-table tr.open-section {
            background-color: var(--open-section);
        }
        
        .section-table tr.professor-row {
            background-color: #f9f9f9;
            font-style: italic;
        }
        
        .professor-cell {
            text-align: right;
        }
        
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .color-box {
            width: 1rem;
            height: 1rem;
            border-radius: 3px;
        }
        
        .green {
            background-color: var(--open-section);
        }
        
        .blue {
            background-color: #D4F1F9;
        }
        
        @media screen and (max-width: 767px) {
            .section-table th, 
            .section-table td {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            /* Hide less important columns on small screens */
            .hide-on-mobile {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>DLSU Course Offerings Search</h1>
    </header>
    
    <div class="container">
        <div class="card">
            <div class="instructions">
                <p>Enter course codes separated by commas (e.g., CSALGCM, GERIZAL, GELITPH) to search for available sections.</p>
            </div>
            
            <div class="search-form">
                <input type="text" id="courseCode" placeholder="Enter course codes (e.g., CSALGCM, GERIZAL)" maxlength="200">
                <button id="searchButton">Search</button>
            </div>
            
            <div class="error" id="errorMessage"></div>
            <div class="loading" id="loadingIndicator">Searching for course offerings...</div>
            
            <div id="resultsContainer" class="results-container"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="color-box green"></div>
                    <span>Open Section</span>
                </div>
                <div class="legend-item">
                    <div class="color-box blue"></div>
                    <span>Closed Section</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchButton = document.getElementById('searchButton');
            const courseCodeInput = document.getElementById('courseCode');
            const resultsContainer = document.getElementById('resultsContainer');
            const errorMessage = document.getElementById('errorMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');

            const proxyUrl = '/api/search';

            // Add enter key support
            courseCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCourses();
                }
            });

            searchButton.addEventListener('click', searchCourses);

            function searchCourses() {
                const courseCodes = courseCodeInput.value.trim().toUpperCase().split(',');
                
                if (!courseCodes.length || courseCodes[0] === '') {
                    showError('Please enter at least one course code');
                    return;
                }
                
                // Clear previous results
                resultsContainer.innerHTML = '';
                hideError();
                
                let promises = [];
                
                // Search each course code and collect promises
                courseCodes.forEach(courseCode => {
                    const trimmedCourseCode = courseCode.trim();
                    if (trimmedCourseCode) {
                        promises.push(fetchCourseOfferings(trimmedCourseCode));
                    }
                });
                
                showLoading();
                
                // Wait for all fetches to complete
                Promise.all(promises)
                    .then(results => {
                        hideLoading();
                        
                        results.forEach(data => {
                            if (!data || data.error) {
                                showError(`Error fetching ${data ? data.courseCode : 'course'}: ${data?.error || 'Failed to fetch course offerings'}`);
                                return;
                            }
                            
                            if (data.noResults) {
                                const courseContainer = document.createElement('div');
                                courseContainer.classList.add('course-container');
                                
                                const courseHeader = document.createElement('div');
                                courseHeader.classList.add('course-header');
                                
                                const courseTitle = document.createElement('h2');
                                courseTitle.classList.add('course-title');
                                courseTitle.textContent = `Course: ${data.courseCode}`;
                                courseHeader.appendChild(courseTitle);
                                courseContainer.appendChild(courseHeader);
                                
                                const noResultsMessage = document.createElement('p');
                                noResultsMessage.textContent = `No course sections found for ${data.courseCode}.`;
                                courseContainer.appendChild(noResultsMessage);
                                
                                resultsContainer.appendChild(courseContainer);
                                return;
                            }
                            
                            displayResults(data);
                        });
                    })
                    .catch(error => {
                        hideLoading();
                        showError(`Error: ${error.message}`);
                    });
            }
            
            async function fetchCourseOfferings(courseCode) {
                try {
                    const response = await fetch(`${proxyUrl}?course=${encodeURIComponent(courseCode)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.courseCode) {
                        data.courseCode = courseCode;
                    }
                    return data;
                } catch (error) {
                    console.error('Fetch error:', error);
                    return { error: error.message, courseCode: courseCode };
                }
            }
            
            function displayResults(data) {
                console.log('Displaying results for:', data.courseCode, 'Received data:', data); // Log the entire data object

                const courseCode = data.courseCode;

                // Create a container for each course's results
                const courseContainer = document.createElement('div');
                courseContainer.classList.add('course-container');

                // Create a header for the course
                const courseHeader = document.createElement('div');
                courseHeader.classList.add('course-header');
                
                const courseTitle = document.createElement('h2');
                courseTitle.classList.add('course-title');
                courseTitle.textContent = `Course: ${courseCode}`;
                courseHeader.appendChild(courseTitle);
                
                // Add section count info
                const sectionInfo = document.createElement('span');
                const openSections = data.sections.filter(s => s.isOpen).length;
                sectionInfo.textContent = `${openSections}/${data.sections.length} open sections`;
                courseHeader.appendChild(sectionInfo);
                
                // Add last updated info
                if (data.lastUpdated) {
                    console.log('Found lastUpdated field:', data.lastUpdated); // Log if the field exists
                    const lastUpdatedInfo = document.createElement('span');
                    lastUpdatedInfo.classList.add('last-updated');
                    const formattedTime = formatTimeAgo(data.lastUpdated);
                    console.log('Formatted time:', formattedTime); // Log the result of formatTimeAgo
                    lastUpdatedInfo.textContent = `Last Updated: ${formattedTime}`;
                    courseHeader.appendChild(lastUpdatedInfo);
                } else {
                    console.log('No lastUpdated field found for:', courseCode); // Log if the field is missing
                }
                
                courseContainer.appendChild(courseHeader);

                // Create a responsive table wrapper
                const tableWrapper = document.createElement('div');
                tableWrapper.classList.add('table-responsive');

                const table = document.createElement('table');
                table.classList.add('section-table');
                
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');

                // Define headers with responsive classes
                const headers = [
                    { text: 'Class#', class: '' },
                    { text: 'Section', class: '' },
                    { text: 'Day/s', class: '' },
                    { text: 'Time', class: '' },
                    { text: 'Room', class: '' },
                    { text: 'Cap', class: 'hide-on-mobile' },
                    { text: 'Enrolled', class: '' },
                    { text: 'Remarks', class: 'hide-on-mobile' }
                ];

                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header.text;
                    if (header.class) {
                        th.classList.add(header.class);
                    }
                    headerRow.appendChild(th);
                });

                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');

                data.sections.forEach(section => {
                    for (let i = 0; i < section.days.length; i++) {
                        const row = document.createElement('tr');
                        if (section.isOpen) {
                            row.classList.add('open-section');
                        }

                        if (i === 0) {
                            const classNbrCell = document.createElement('td');
                            classNbrCell.textContent = section.classNbr;
                            row.appendChild(classNbrCell);

                            const sectionCell = document.createElement('td');
                            sectionCell.textContent = section.section;
                            row.appendChild(sectionCell);
                        } else {
                            for (let j = 0; j < 2; j++) {
                                const emptyCell = document.createElement('td');
                                row.appendChild(emptyCell);
                            }
                        }

                        const dayCell = document.createElement('td');
                        dayCell.textContent = section.days[i];
                        row.appendChild(dayCell);

                        const timeCell = document.createElement('td');
                        timeCell.textContent = section.times[i];
                        row.appendChild(timeCell);

                        const roomCell = document.createElement('td');
                        roomCell.textContent = section.rooms[i];
                        row.appendChild(roomCell);

                        if (i === 0) {
                            const enrlCapCell = document.createElement('td');
                            enrlCapCell.textContent = section.enrlCap;
                            enrlCapCell.classList.add('hide-on-mobile');
                            row.appendChild(enrlCapCell);

                            const enrolledCell = document.createElement('td');
                            enrolledCell.textContent = section.enrolled;
                            row.appendChild(enrolledCell);

                            const remarksCell = document.createElement('td');
                            remarksCell.textContent = section.remarks;
                            remarksCell.classList.add('hide-on-mobile');
                            row.appendChild(remarksCell);
                        } else {
                            // Add empty cells for cap, enrolled, and remarks on subsequent rows
                            const enrlCapCell = document.createElement('td');
                            enrlCapCell.classList.add('hide-on-mobile');
                            row.appendChild(enrlCapCell);

                            const enrolledCell = document.createElement('td');
                            row.appendChild(enrolledCell);

                            const remarksCell = document.createElement('td');
                            remarksCell.classList.add('hide-on-mobile');
                            row.appendChild(remarksCell);
                        }
                        tbody.appendChild(row);

                        if (i === section.days.length - 1) {
                            const professorRow = document.createElement('tr');
                            professorRow.classList.add('professor-row');

                            const professorCell = document.createElement('td');
                            professorCell.colSpan = 8;
                            professorCell.classList.add('professor-cell');
                            professorCell.textContent = section.professor;

                            professorRow.appendChild(professorCell);
                            tbody.appendChild(professorRow);
                        }
                    }
                });

                table.appendChild(tbody);
                tableWrapper.appendChild(table);
                courseContainer.appendChild(tableWrapper);
                resultsContainer.appendChild(courseContainer);
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            function hideError() {
                errorMessage.style.display = 'none';
            }
            
            function showLoading() {
                loadingIndicator.style.display = 'block';
            }
            
            function hideLoading() {
                loadingIndicator.style.display = 'none';
            }

            function formatTimeAgo(dateInput) {
                let dateString;
                // Check if the input is an object with a $date property
                if (typeof dateInput === 'object' && dateInput !== null && dateInput.$date) {
                    dateString = dateInput.$date;
                } else {
                    // Assume it's already a string or directly parsable
                    dateString = dateInput;
                }

                if (!dateString) return ''; // Return empty if no valid date found

                const now = new Date();
                const lastUpdated = new Date(dateString);

                // Check if the date is valid after parsing
                if (isNaN(lastUpdated.getTime())) {
                    console.error("Invalid date string received:", dateString);
                    return 'Invalid date'; 
                }

                const diffMs = now - lastUpdated;
                
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                
                if (diffHours >= 1) {
                    return `${diffHours} ${diffHours === 1 ? 'hour' : 'hours'} ago`;
                } else if (diffMinutes >= 0) { // Ensure minutes are not negative
                    return `${diffMinutes} ${diffMinutes === 1 ? 'minute' : 'minutes'} ago`;
                } else {
                    return 'just now'; // Handle cases where the difference is very small or negative
                }
            }
        });
    </script>
</body>
</html>